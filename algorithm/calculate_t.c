#ifndef CALCULATE_T_H
#define CALCULATE_T_H
#include <math.h>
double calculate_t(const double air_pos[],
		   const double air_vel[],
		   const double air_rad,
		   const double obs_pos[],
		   const double obs_vel[],
		   const double obs_rad,
		   int *ray){

   // Set up the variables

  double r    = air_rad + obs_rad;
  double v1_x = air_vel[0];
  double v1_y = air_vel[1];
  double v1_z = air_vel[2];
  double vx   = obs_vel[0];
  double vy   = obs_vel[1];
  double vz   = obs_vel[2];
  double x2   = obs_pos[0];
  double y2   = obs_pos[1];
  double z2   = obs_pos[2];
  double x_0  = air_pos[0];
  double y_0  = air_pos[1];
  double z_0  = air_pos[2];

  double denom = (pow(v1_x,2.0)*pow(vy,2.0) + pow(v1_x,2.0)*pow(vz,2.0) - 2*v1_x*v1_y*vx*vy - 2*v1_x*v1_z*vx*vz + pow(v1_y,2.0)*pow(vx,2.0) + pow(v1_y,2.0)*pow(vz,2.0) - 2*v1_y*v1_z*vy*vz + pow(v1_z,2.0)*pow(vx,2.0) + pow(v1_z,2.0)*pow(vy,2.0));
  if ( denom == 0 ){
    *ray = TRUE;
    return 0;
  }
  *ray = FALSE;
  double t = (sqrt(pow(r,2.0)*pow(v1_x,2.0)*pow(vy,2.0) + pow(r,2.0)*pow(v1_x,2.0)*pow(vz,2.0) - 2*pow(r,2.0)*v1_x*v1_y*vx*vy - 2*pow(r,2.0)*v1_x*v1_z*vx*vz + pow(r,2.0)*pow(v1_y,2.0)*pow(vx,2.0) + pow(r,2.0)*pow(v1_y,2.0)*pow(vz,2.0) - 2*pow(r,2.0)*v1_y*v1_z*vy*vz + pow(r,2.0)*pow(v1_z,2.0)*pow(vx,2.0) + pow(r,2.0)*pow(v1_z,2.0)*pow(vy,2.0) - pow(v1_x,2.0)*pow(vx,2.0)*pow(vy,2.0)*pow(z2,2.0) + 2*pow(v1_x,2.0)*pow(vx,2.0)*pow(vy,2.0)*z2*z_0 - pow(v1_x,2.0)*pow(vx,2.0)*pow(vy,2.0)*pow(z_0,2.0) + 2*pow(v1_x,2.0)*pow(vx,2.0)*vy*vz*y2*z2 - 2*pow(v1_x,2.0)*pow(vx,2.0)*vy*vz*y2*z_0 - 2*pow(v1_x,2.0)*pow(vx,2.0)*vy*vz*y_0*z2 + 2*pow(v1_x,2.0)*pow(vx,2.0)*vy*vz*y_0*z_0 - pow(v1_x,2.0)*pow(vx,2.0)*pow(vz,2.0)*pow(y2,2.0) + 2*pow(v1_x,2.0)*pow(vx,2.0)*pow(vz,2.0)*y2*y_0 - pow(v1_x,2.0)*pow(vx,2.0)*pow(vz,2.0)*pow(y_0,2.0) - pow(v1_x,2.0)*pow(vy,4.0)*pow(z2,2.0) + 2*pow(v1_x,2.0)*pow(vy,4.0)*z2*z_0 - pow(v1_x,2.0)*pow(vy,4.0)*pow(z_0,2.0) + 2*pow(v1_x,2.0)*pow(vy,3.0)*vz*y2*z2 - 2*pow(v1_x,2.0)*pow(vy,3.0)*vz*y2*z_0 - 2*pow(v1_x,2.0)*pow(vy,3.0)*vz*y_0*z2 + 2*pow(v1_x,2.0)*pow(vy,3.0)*vz*y_0*z_0 - pow(v1_x,2.0)*pow(vy,2.0)*pow(vz,2.0)*pow(y2,2.0) + 2*pow(v1_x,2.0)*pow(vy,2.0)*pow(vz,2.0)*y2*y_0 - pow(v1_x,2.0)*pow(vy,2.0)*pow(vz,2.0)*pow(y_0,2.0) - pow(v1_x,2.0)*pow(vy,2.0)*pow(vz,2.0)*pow(z2,2.0) + 2*pow(v1_x,2.0)*pow(vy,2.0)*pow(vz,2.0)*z2*z_0 - pow(v1_x,2.0)*pow(vy,2.0)*pow(vz,2.0)*pow(z_0,2.0) + 2*pow(v1_x,2.0)*vy*pow(vz,3.0)*y2*z2 - 2*pow(v1_x,2.0)*vy*pow(vz,3.0)*y2*z_0 - 2*pow(v1_x,2.0)*vy*pow(vz,3.0)*y_0*z2 + 2*pow(v1_x,2.0)*vy*pow(vz,3.0)*y_0*z_0 - pow(v1_x,2.0)*pow(vz,4.0)*pow(y2,2.0) + 2*pow(v1_x,2.0)*pow(vz,4.0)*y2*y_0 - pow(v1_x,2.0)*pow(vz,4.0)*pow(y_0,2.0) + 2*v1_x*v1_y*pow(vx,3.0)*vy*pow(z2,2.0) - 4*v1_x*v1_y*pow(vx,3.0)*vy*z2*z_0 + 2*v1_x*v1_y*pow(vx,3.0)*vy*pow(z_0,2.0) - 2*v1_x*v1_y*pow(vx,3.0)*vz*y2*z2 + 2*v1_x*v1_y*pow(vx,3.0)*vz*y2*z_0 + 2*v1_x*v1_y*pow(vx,3.0)*vz*y_0*z2 - 2*v1_x*v1_y*pow(vx,3.0)*vz*y_0*z_0 - 2*v1_x*v1_y*pow(vx,2.0)*vy*vz*x2*z2 + 2*v1_x*v1_y*pow(vx,2.0)*vy*vz*x2*z_0 + 2*v1_x*v1_y*pow(vx,2.0)*vy*vz*x_0*z2 - 2*v1_x*v1_y*pow(vx,2.0)*vy*vz*x_0*z_0 + 2*v1_x*v1_y*pow(vx,2.0)*pow(vz,2.0)*x2*y2 - 2*v1_x*v1_y*pow(vx,2.0)*pow(vz,2.0)*x2*y_0 - 2*v1_x*v1_y*pow(vx,2.0)*pow(vz,2.0)*x_0*y2 + 2*v1_x*v1_y*pow(vx,2.0)*pow(vz,2.0)*x_0*y_0 + 2*v1_x*v1_y*vx*pow(vy,3.0)*pow(z2,2.0) - 4*v1_x*v1_y*vx*pow(vy,3.0)*z2*z_0 + 2*v1_x*v1_y*vx*pow(vy,3.0)*pow(z_0,2.0) - 2*v1_x*v1_y*vx*pow(vy,2.0)*vz*y2*z2 + 2*v1_x*v1_y*vx*pow(vy,2.0)*vz*y2*z_0 + 2*v1_x*v1_y*vx*pow(vy,2.0)*vz*y_0*z2 - 2*v1_x*v1_y*vx*pow(vy,2.0)*vz*y_0*z_0 + 2*v1_x*v1_y*vx*vy*pow(vz,2.0)*pow(z2,2.0) - 4*v1_x*v1_y*vx*vy*pow(vz,2.0)*z2*z_0 + 2*v1_x*v1_y*vx*vy*pow(vz,2.0)*pow(z_0,2.0) - 2*v1_x*v1_y*vx*pow(vz,3.0)*y2*z2 + 2*v1_x*v1_y*vx*pow(vz,3.0)*y2*z_0 + 2*v1_x*v1_y*vx*pow(vz,3.0)*y_0*z2 - 2*v1_x*v1_y*vx*pow(vz,3.0)*y_0*z_0 - 2*v1_x*v1_y*pow(vy,3.0)*vz*x2*z2 + 2*v1_x*v1_y*pow(vy,3.0)*vz*x2*z_0 + 2*v1_x*v1_y*pow(vy,3.0)*vz*x_0*z2 - 2*v1_x*v1_y*pow(vy,3.0)*vz*x_0*z_0 + 2*v1_x*v1_y*pow(vy,2.0)*pow(vz,2.0)*x2*y2 - 2*v1_x*v1_y*pow(vy,2.0)*pow(vz,2.0)*x2*y_0 - 2*v1_x*v1_y*pow(vy,2.0)*pow(vz,2.0)*x_0*y2 + 2*v1_x*v1_y*pow(vy,2.0)*pow(vz,2.0)*x_0*y_0 - 2*v1_x*v1_y*vy*pow(vz,3.0)*x2*z2 + 2*v1_x*v1_y*vy*pow(vz,3.0)*x2*z_0 + 2*v1_x*v1_y*vy*pow(vz,3.0)*x_0*z2 - 2*v1_x*v1_y*vy*pow(vz,3.0)*x_0*z_0 + 2*v1_x*v1_y*pow(vz,4.0)*x2*y2 - 2*v1_x*v1_y*pow(vz,4.0)*x2*y_0 - 2*v1_x*v1_y*pow(vz,4.0)*x_0*y2 + 2*v1_x*v1_y*pow(vz,4.0)*x_0*y_0 - 2*v1_x*v1_z*pow(vx,3.0)*vy*y2*z2 + 2*v1_x*v1_z*pow(vx,3.0)*vy*y2*z_0 + 2*v1_x*v1_z*pow(vx,3.0)*vy*y_0*z2 - 2*v1_x*v1_z*pow(vx,3.0)*vy*y_0*z_0 + 2*v1_x*v1_z*pow(vx,3.0)*vz*pow(y2,2.0) - 4*v1_x*v1_z*pow(vx,3.0)*vz*y2*y_0 + 2*v1_x*v1_z*pow(vx,3.0)*vz*pow(y_0,2.0) + 2*v1_x*v1_z*pow(vx,2.0)*pow(vy,2.0)*x2*z2 - 2*v1_x*v1_z*pow(vx,2.0)*pow(vy,2.0)*x2*z_0 - 2*v1_x*v1_z*pow(vx,2.0)*pow(vy,2.0)*x_0*z2 + 2*v1_x*v1_z*pow(vx,2.0)*pow(vy,2.0)*x_0*z_0 - 2*v1_x*v1_z*pow(vx,2.0)*vy*vz*x2*y2 + 2*v1_x*v1_z*pow(vx,2.0)*vy*vz*x2*y_0 + 2*v1_x*v1_z*pow(vx,2.0)*vy*vz*x_0*y2 - 2*v1_x*v1_z*pow(vx,2.0)*vy*vz*x_0*y_0 - 2*v1_x*v1_z*vx*pow(vy,3.0)*y2*z2 + 2*v1_x*v1_z*vx*pow(vy,3.0)*y2*z_0 + 2*v1_x*v1_z*vx*pow(vy,3.0)*y_0*z2 - 2*v1_x*v1_z*vx*pow(vy,3.0)*y_0*z_0 + 2*v1_x*v1_z*vx*pow(vy,2.0)*vz*pow(y2,2.0) - 4*v1_x*v1_z*vx*pow(vy,2.0)*vz*y2*y_0 + 2*v1_x*v1_z*vx*pow(vy,2.0)*vz*pow(y_0,2.0) - 2*v1_x*v1_z*vx*vy*pow(vz,2.0)*y2*z2 + 2*v1_x*v1_z*vx*vy*pow(vz,2.0)*y2*z_0 + 2*v1_x*v1_z*vx*vy*pow(vz,2.0)*y_0*z2 - 2*v1_x*v1_z*vx*vy*pow(vz,2.0)*y_0*z_0 + 2*v1_x*v1_z*vx*pow(vz,3.0)*pow(y2,2.0) - 4*v1_x*v1_z*vx*pow(vz,3.0)*y2*y_0 + 2*v1_x*v1_z*vx*pow(vz,3.0)*pow(y_0,2.0) + 2*v1_x*v1_z*pow(vy,4.0)*x2*z2 - 2*v1_x*v1_z*pow(vy,4.0)*x2*z_0 - 2*v1_x*v1_z*pow(vy,4.0)*x_0*z2 + 2*v1_x*v1_z*pow(vy,4.0)*x_0*z_0 - 2*v1_x*v1_z*pow(vy,3.0)*vz*x2*y2 + 2*v1_x*v1_z*pow(vy,3.0)*vz*x2*y_0 + 2*v1_x*v1_z*pow(vy,3.0)*vz*x_0*y2 - 2*v1_x*v1_z*pow(vy,3.0)*vz*x_0*y_0 + 2*v1_x*v1_z*pow(vy,2.0)*pow(vz,2.0)*x2*z2 - 2*v1_x*v1_z*pow(vy,2.0)*pow(vz,2.0)*x2*z_0 - 2*v1_x*v1_z*pow(vy,2.0)*pow(vz,2.0)*x_0*z2 + 2*v1_x*v1_z*pow(vy,2.0)*pow(vz,2.0)*x_0*z_0 - 2*v1_x*v1_z*vy*pow(vz,3.0)*x2*y2 + 2*v1_x*v1_z*vy*pow(vz,3.0)*x2*y_0 + 2*v1_x*v1_z*vy*pow(vz,3.0)*x_0*y2 - 2*v1_x*v1_z*vy*pow(vz,3.0)*x_0*y_0 - pow(v1_y,2.0)*pow(vx,4.0)*pow(z2,2.0) + 2*pow(v1_y,2.0)*pow(vx,4.0)*z2*z_0 - pow(v1_y,2.0)*pow(vx,4.0)*pow(z_0,2.0) + 2*pow(v1_y,2.0)*pow(vx,3.0)*vz*x2*z2 - 2*pow(v1_y,2.0)*pow(vx,3.0)*vz*x2*z_0 - 2*pow(v1_y,2.0)*pow(vx,3.0)*vz*x_0*z2 + 2*pow(v1_y,2.0)*pow(vx,3.0)*vz*x_0*z_0 - pow(v1_y,2.0)*pow(vx,2.0)*pow(vy,2.0)*pow(z2,2.0) + 2*pow(v1_y,2.0)*pow(vx,2.0)*pow(vy,2.0)*z2*z_0 - pow(v1_y,2.0)*pow(vx,2.0)*pow(vy,2.0)*pow(z_0,2.0) - pow(v1_y,2.0)*pow(vx,2.0)*pow(vz,2.0)*pow(x2,2.0) + 2*pow(v1_y,2.0)*pow(vx,2.0)*pow(vz,2.0)*x2*x_0 - pow(v1_y,2.0)*pow(vx,2.0)*pow(vz,2.0)*pow(x_0,2.0) - pow(v1_y,2.0)*pow(vx,2.0)*pow(vz,2.0)*pow(z2,2.0) + 2*pow(v1_y,2.0)*pow(vx,2.0)*pow(vz,2.0)*z2*z_0 - pow(v1_y,2.0)*pow(vx,2.0)*pow(vz,2.0)*pow(z_0,2.0) + 2*pow(v1_y,2.0)*vx*pow(vy,2.0)*vz*x2*z2 - 2*pow(v1_y,2.0)*vx*pow(vy,2.0)*vz*x2*z_0 - 2*pow(v1_y,2.0)*vx*pow(vy,2.0)*vz*x_0*z2 + 2*pow(v1_y,2.0)*vx*pow(vy,2.0)*vz*x_0*z_0 + 2*pow(v1_y,2.0)*vx*pow(vz,3.0)*x2*z2 - 2*pow(v1_y,2.0)*vx*pow(vz,3.0)*x2*z_0 - 2*pow(v1_y,2.0)*vx*pow(vz,3.0)*x_0*z2 + 2*pow(v1_y,2.0)*vx*pow(vz,3.0)*x_0*z_0 - pow(v1_y,2.0)*pow(vy,2.0)*pow(vz,2.0)*pow(x2,2.0) + 2*pow(v1_y,2.0)*pow(vy,2.0)*pow(vz,2.0)*x2*x_0 - pow(v1_y,2.0)*pow(vy,2.0)*pow(vz,2.0)*pow(x_0,2.0) - pow(v1_y,2.0)*pow(vz,4.0)*pow(x2,2.0) + 2*pow(v1_y,2.0)*pow(vz,4.0)*x2*x_0 - pow(v1_y,2.0)*pow(vz,4.0)*pow(x_0,2.0) + 2*v1_y*v1_z*pow(vx,4.0)*y2*z2 - 2*v1_y*v1_z*pow(vx,4.0)*y2*z_0 - 2*v1_y*v1_z*pow(vx,4.0)*y_0*z2 + 2*v1_y*v1_z*pow(vx,4.0)*y_0*z_0 - 2*v1_y*v1_z*pow(vx,3.0)*vy*x2*z2 + 2*v1_y*v1_z*pow(vx,3.0)*vy*x2*z_0 + 2*v1_y*v1_z*pow(vx,3.0)*vy*x_0*z2 - 2*v1_y*v1_z*pow(vx,3.0)*vy*x_0*z_0 - 2*v1_y*v1_z*pow(vx,3.0)*vz*x2*y2 + 2*v1_y*v1_z*pow(vx,3.0)*vz*x2*y_0 + 2*v1_y*v1_z*pow(vx,3.0)*vz*x_0*y2 - 2*v1_y*v1_z*pow(vx,3.0)*vz*x_0*y_0 + 2*v1_y*v1_z*pow(vx,2.0)*pow(vy,2.0)*y2*z2 - 2*v1_y*v1_z*pow(vx,2.0)*pow(vy,2.0)*y2*z_0 - 2*v1_y*v1_z*pow(vx,2.0)*pow(vy,2.0)*y_0*z2 + 2*v1_y*v1_z*pow(vx,2.0)*pow(vy,2.0)*y_0*z_0 + 2*v1_y*v1_z*pow(vx,2.0)*vy*vz*pow(x2,2.0) - 4*v1_y*v1_z*pow(vx,2.0)*vy*vz*x2*x_0 + 2*v1_y*v1_z*pow(vx,2.0)*vy*vz*pow(x_0,2.0) + 2*v1_y*v1_z*pow(vx,2.0)*pow(vz,2.0)*y2*z2 - 2*v1_y*v1_z*pow(vx,2.0)*pow(vz,2.0)*y2*z_0 - 2*v1_y*v1_z*pow(vx,2.0)*pow(vz,2.0)*y_0*z2 + 2*v1_y*v1_z*pow(vx,2.0)*pow(vz,2.0)*y_0*z_0 - 2*v1_y*v1_z*vx*pow(vy,3.0)*x2*z2 + 2*v1_y*v1_z*vx*pow(vy,3.0)*x2*z_0 + 2*v1_y*v1_z*vx*pow(vy,3.0)*x_0*z2 - 2*v1_y*v1_z*vx*pow(vy,3.0)*x_0*z_0 - 2*v1_y*v1_z*vx*pow(vy,2.0)*vz*x2*y2 + 2*v1_y*v1_z*vx*pow(vy,2.0)*vz*x2*y_0 + 2*v1_y*v1_z*vx*pow(vy,2.0)*vz*x_0*y2 - 2*v1_y*v1_z*vx*pow(vy,2.0)*vz*x_0*y_0 - 2*v1_y*v1_z*vx*vy*pow(vz,2.0)*x2*z2 + 2*v1_y*v1_z*vx*vy*pow(vz,2.0)*x2*z_0 + 2*v1_y*v1_z*vx*vy*pow(vz,2.0)*x_0*z2 - 2*v1_y*v1_z*vx*vy*pow(vz,2.0)*x_0*z_0 - 2*v1_y*v1_z*vx*pow(vz,3.0)*x2*y2 + 2*v1_y*v1_z*vx*pow(vz,3.0)*x2*y_0 + 2*v1_y*v1_z*vx*pow(vz,3.0)*x_0*y2 - 2*v1_y*v1_z*vx*pow(vz,3.0)*x_0*y_0 + 2*v1_y*v1_z*pow(vy,3.0)*vz*pow(x2,2.0) - 4*v1_y*v1_z*pow(vy,3.0)*vz*x2*x_0 + 2*v1_y*v1_z*pow(vy,3.0)*vz*pow(x_0,2.0) + 2*v1_y*v1_z*vy*pow(vz,3.0)*pow(x2,2.0) - 4*v1_y*v1_z*vy*pow(vz,3.0)*x2*x_0 + 2*v1_y*v1_z*vy*pow(vz,3.0)*pow(x_0,2.0) - pow(v1_z,2.0)*pow(vx,4.0)*pow(y2,2.0) + 2*pow(v1_z,2.0)*pow(vx,4.0)*y2*y_0 - pow(v1_z,2.0)*pow(vx,4.0)*pow(y_0,2.0) + 2*pow(v1_z,2.0)*pow(vx,3.0)*vy*x2*y2 - 2*pow(v1_z,2.0)*pow(vx,3.0)*vy*x2*y_0 - 2*pow(v1_z,2.0)*pow(vx,3.0)*vy*x_0*y2 + 2*pow(v1_z,2.0)*pow(vx,3.0)*vy*x_0*y_0 - pow(v1_z,2.0)*pow(vx,2.0)*pow(vy,2.0)*pow(x2,2.0) + 2*pow(v1_z,2.0)*pow(vx,2.0)*pow(vy,2.0)*x2*x_0 - pow(v1_z,2.0)*pow(vx,2.0)*pow(vy,2.0)*pow(x_0,2.0) - pow(v1_z,2.0)*pow(vx,2.0)*pow(vy,2.0)*pow(y2,2.0) + 2*pow(v1_z,2.0)*pow(vx,2.0)*pow(vy,2.0)*y2*y_0 - pow(v1_z,2.0)*pow(vx,2.0)*pow(vy,2.0)*pow(y_0,2.0) - pow(v1_z,2.0)*pow(vx,2.0)*pow(vz,2.0)*pow(y2,2.0) + 2*pow(v1_z,2.0)*pow(vx,2.0)*pow(vz,2.0)*y2*y_0 - pow(v1_z,2.0)*pow(vx,2.0)*pow(vz,2.0)*pow(y_0,2.0) + 2*pow(v1_z,2.0)*vx*pow(vy,3.0)*x2*y2 - 2*pow(v1_z,2.0)*vx*pow(vy,3.0)*x2*y_0 - 2*pow(v1_z,2.0)*vx*pow(vy,3.0)*x_0*y2 + 2*pow(v1_z,2.0)*vx*pow(vy,3.0)*x_0*y_0 + 2*pow(v1_z,2.0)*vx*vy*pow(vz,2.0)*x2*y2 - 2*pow(v1_z,2.0)*vx*vy*pow(vz,2.0)*x2*y_0 - 2*pow(v1_z,2.0)*vx*vy*pow(vz,2.0)*x_0*y2 + 2*pow(v1_z,2.0)*vx*vy*pow(vz,2.0)*x_0*y_0 - pow(v1_z,2.0)*pow(vy,4.0)*pow(x2,2.0) + 2*pow(v1_z,2.0)*pow(vy,4.0)*x2*x_0 - pow(v1_z,2.0)*pow(vy,4.0)*pow(x_0,2.0) - pow(v1_z,2.0)*pow(vy,2.0)*pow(vz,2.0)*pow(x2,2.0) + 2*pow(v1_z,2.0)*pow(vy,2.0)*pow(vz,2.0)*x2*x_0 - pow(v1_z,2.0)*pow(vy,2.0)*pow(vz,2.0)*pow(x_0,2.0)) + v1_x*pow(vy,2.0)*x2 + v1_x*pow(vz,2.0)*x2 - v1_x*pow(vy,2.0)*x_0 - v1_x*pow(vz,2.0)*x_0 + v1_y*pow(vx,2.0)*y2 + v1_y*pow(vz,2.0)*y2 - v1_y*pow(vx,2.0)*y_0 - v1_y*pow(vz,2.0)*y_0 + v1_z*pow(vx,2.0)*z2 + v1_z*pow(vy,2.0)*z2 - v1_z*pow(vx,2.0)*z_0 - v1_z*pow(vy,2.0)*z_0 - v1_y*vx*vy*x2 - v1_z*vx*vz*x2 + v1_y*vx*vy*x_0 + v1_z*vx*vz*x_0 - v1_x*vx*vy*y2 - v1_z*vy*vz*y2 + v1_x*vx*vy*y_0 + v1_z*vy*vz*y_0 - v1_x*vx*vz*z2 - v1_y*vy*vz*z2 + v1_x*vx*vz*z_0 + v1_y*vy*vz*z_0)/denom;
   return t;
}
#endif
